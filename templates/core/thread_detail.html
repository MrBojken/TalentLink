{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <h2>Conversation for {{ thread.job.title }}</h2>
    <div class="card">
        <div class="card-body" id="message-container" style="height: 400px; overflow-y: scroll;">
            {% for message in messages %}
            <div class="d-flex mb-3 {% if message.sender == user %}justify-content-end{% else %}justify-content-start{% endif %}">
                <div class="p-2 {% if message.sender == user %}bg-primary text-white{% else %}bg-light{% endif %} rounded" style="max-width: 75%;">
                    <div class="d-flex align-items-center">
                        {% if message.sender.profile.profile_picture %}
                        <img src="{{ message.sender.profile.profile_picture.url }}" alt="Profile Picture" class="rounded-circle me-2" style="width: 40px; height: 40px; object-fit: cover;">
                        {% else %}
                        <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                            ?
                        </div>
                        {% endif %}
                        <small class="text-muted d-block {% if message.sender == user %}text-end text-white-50{% else %}text-start{% endif %}">
                            <a href="{% url 'profile_view' username=message.sender.username %}" class="{% if message.sender == user %}text-white-50{% else %}text-muted{% endif %} text-decoration-none">
                                {{ message.sender.username }}
                            </a> - {{ message.timestamp|date:"M d, P" }}
                        </small>
                    </div>
                    {{ message.body }}
                    {% if message.file %}
                        <p class="mt-2">
                            <a href="{{ message.file.url }}" download class="text-decoration-underline text-dark">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-arrow-down-fill me-1" viewBox="0 0 16 16">
                                    <path d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0zM9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1zM8 7a.5.5 0 0 1 .5.5v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 .708-.708L7.5 11.293V7.5A.5.5 0 0 1 8 7z"/>
                                </svg>
                                Download File
                            </a>
                        </p>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <p class="text-center text-muted">No messages yet. Start the conversation!</p>
            {% endfor %}
        </div>
    </div>

    <form method="post" enctype="multipart/form-data" class="mt-3">
        {% csrf_token %}
        <div class="input-group">
            <div class="flex-grow-1 me-2">
                {{ form.body }}
            </div>
            <label class="btn btn-primary" for="id_file" title="Attach File">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-paperclip" viewBox="0 0 16 16">
                    <path d="M4.5 3a2.5 2.5 0 0 1 5 0 .5.5 0 0 0 1 0 3.5 3.5 0 0 0-7 0 .5.5 0 0 0 1 0z"/>
                    <path d="M13.5 6a.5.5 0 0 0-1 0v6.5A2.5 2.5 0 0 1 10 15h-2.5a.5.5 0 0 0 0 1H10A3.5 3.5 0 0 0 13.5 12.5V6z"/>
                </svg>
            </label>
            <input type="file" name="file" id="id_file" class="d-none">
            <button type="submit" class="btn btn-primary" title="Send Message">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-send" viewBox="0 0 16 16">
                    <path d="M15.854.146a.5.5 0 0 1 .11.54L13.525 14.5a.5.5 0 0 1-.9.088L7.001 8.001l-5.626 5.626a.5.5 0 0 1-.908-.06L.18 5.75A.5.5 0 0 1 .075 5.25zM12 6l-6.5 6.5L8.5 8z"/>
                </svg>
            </button>
        </div>
        <span id="file-name" class="text-muted small mt-1 d-block"></span>
    </form>

    <script>
        const fileInput = document.getElementById("id_file");
        const fileNameSpan = document.getElementById("file-name");

        fileInput.addEventListener("change", (event) => {
            if (event.target.files.length > 0) {
                fileNameSpan.textContent = `Attached: ${event.target.files[0].name}`;
            } else {
                fileNameSpan.textContent = "";
            }
        });
    </script>
    <script>
        const messageContainer = document.getElementById('message-container');
        if (messageContainer) {
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }
    </script>
</div>
{% endblock %}